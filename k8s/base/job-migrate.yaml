# Database Migration Job for Survey Service
#
# Trigger manually with:
#   kubectl -n openmeet create job survey-migrate-$(date +%s) --from=job/survey-migrate
#
# Or apply directly:
#   kubectl -n openmeet apply -f job-migrate.yaml
#   kubectl -n openmeet wait --for=condition=complete job/survey-migrate --timeout=60s
#
# Check status:
#   kubectl -n openmeet logs job/survey-migrate
#
# This uses the same container image as the API/consumer, just with different args.

apiVersion: batch/v1
kind: Job
metadata:
  name: survey-migrate
  labels:
    app: survey-migrate
spec:
  # Don't retry failed migrations - manual intervention may be needed
  backoffLimit: 0
  # Clean up completed jobs after 1 hour
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: survey-migrate
    spec:
      restartPolicy: Never
      containers:
        - name: migrate
          image: survey:latest  # Same image as API/consumer
          command:
            - /usr/local/bin/migrate
            - -path
            - /migrations
            - -database
            - $(DATABASE_URL)
            - up
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: survey-secrets
                  key: DATABASE_URL
          resources:
            requests:
              cpu: 50m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
